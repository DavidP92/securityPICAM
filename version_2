import picamera
import time
import smtplib, ssl
from email.mime.multipart import MIMEMultipart
from email.mime.base import MIMEBase
from email.mime.text import MIMEText
from email.utils import formatdate
from email import encoders

def take_shot():
    #global i
    #i = i + 1
    with picamera.PiCamera() as camera:
        camera.rotation = 180
        camera.resolution = (640, 480)
        camera.start_preview()
        camera.capture('/home/pi/images.jpg')
        #camera.capture('/home/pi/Pictures/image_%s.jpg' % i)
    
    print('A photo has been taken')
    time.sleep(10)
    
def stop_cam():
   with picamera.PiCamera() as camera:
       camera.stop_preview()
       print('Camera Shutdown Correctly')
       exit()

def send_email():
    #Protocols
    toaddress = 'davidpaez1006@gmail.com' 
    me ='House Pi Camera'
    subject = 'Home Status'

    msg = MIMEMultipart()
    msg['Subject'] = subject
    msg['From'] = me
    msg['To'] = toaddress
    msg.preamble = "Status Picture update"

    part = MIMEBase = ('application',"octet-stream")
    part.set_payload(open("image.jpg","rb").read())
    encoders.encode_base64(part)
    ##File Name
    part.add_header('Content-Disposition', 'attachment; filename="images.jpg"')
    msg.attach(part)

    try:
        s = smtplib.SMTP('smtp.gmail.com',587)
        s.ehlo()
        s.starttls()
        s.ehlo()
        #User ID
        s.login(user = 'davidpaez1006@gmail.com', password ='November29!')
        s.sendmail(me,toaddr,msg.as_string())
        print('Email Sent')
        s.quit()
    except SMTPException as error:
        print("Error")

       


take_shot()
stop_cam()
send_email()

#   camera.start_preview()
#  camera.start_recording('/home/pi/video.h264')
# time.sleep(10)
#camera.stop_recording()
# camera.stop_preview()

